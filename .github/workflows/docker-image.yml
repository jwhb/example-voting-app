name: Build and scan OCI image

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - context: ./vote
            dockerfile: ./vote/Dockerfile
            image: localhost/voting-app/vote:latest
          - context: ./worker
            dockerfile: ./worker/Dockerfile
            image: localhost/voting-app/worker:latest
          - context: ./result
            dockerfile: ./result/Dockerfile
            image: localhost/voting-app/result:latest

    steps:
    - uses: actions/checkout@v4

    - name: Build the OCI image
      run: docker build ${{ matrix.context }} --file ${{ matrix.dockerfile }} --tag ${{ matrix.image }}

    - name: Scan image
      id: scan
      uses: sysdiglabs/scan-action@v5
      with:
          image-tag: ${{ matrix.image }}
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
          sysdig-secure-url: ${{ secrets.SYSDIG_SECURE_URL }}

    - name: Upload SARIF file
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ github.workspace }}/sarif.json
